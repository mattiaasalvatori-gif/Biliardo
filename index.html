import React, { useState, useEffect } from 'react';
import { Users, Plus, ArrowRight, Trophy, Target, TrendingUp, Award, BarChart3 } from 'lucide-react';

const BiliardoApp = () => {
  const [currentPage, setCurrentPage] = useState('home');
  const [selectedMode, setSelectedMode] = useState(null);
  const [players, setPlayers] = useState([]);
  const [gameState, setGameState] = useState(null);
  const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
  const [globalStats, setGlobalStats] = useState({});
  const [trackedPlayers, setTrackedPlayers] = useState([]);
  const [showMatchStats, setShowMatchStats] = useState(false);
  const [ballType, setBallType] = useState(null);
  const [remainingBalls, setRemainingBalls] = useState({
    solid: [1, 2, 3, 4, 5, 6, 7],
    striped: [9, 10, 11, 12, 13, 14, 15]
  });
  const [ball9Remaining, setBall9Remaining] = useState([1, 2, 3, 4, 5, 6, 7, 8, 9]);
  const [gameTime, setGameTime] = useState(0);
  const [showResetModal, setShowResetModal] = useState(false);

  useEffect(() => {
    const savedStats = localStorage.getItem('globalPlayerStats');
    if (savedStats) {
      setGlobalStats(JSON.parse(savedStats));
    }
  }, []);

  // Timer di gioco
  useEffect(() => {
    let interval;
    if (gameState && !gameState.isFinished) {
      interval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - new Date(gameState.startTime).getTime()) / 1000);
        setGameTime(elapsed);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [gameState]);

  const saveGlobalStats = (stats) => {
    localStorage.setItem('globalPlayerStats', JSON.stringify(stats));
    setGlobalStats(stats);
  };

  const modes = {
    duo: { name: 'Duo', playerCount: 2, fixed: true },
    trio: { name: 'Trio', playerCount: 3, fixed: true },
    'trio-ffa': { name: 'Trio - Tutti contro tutti', playerCount: 3, fixed: true },
    'trio-ball9': { name: 'Trio - Palla 9', playerCount: 3, fixed: true },
    quartetto: { name: 'Quartetto', playerCount: 4, fixed: true },
    torneo: { name: 'Torneo', playerCount: 4, fixed: false }
  };

  const handleModeSelect = (mode) => {
    setSelectedMode(mode);
    
    // Se √® Trio, mostra le sotto-modalit√†
    if (mode === 'trio') {
      setCurrentPage('trio-submodes');
    } else {
      const initialPlayers = Array(modes[mode].playerCount).fill('');
      setPlayers(initialPlayers);
      setTrackedPlayers(Array(modes[mode].playerCount).fill(false));
      setCurrentPage('players');
    }
  };

  const handleTrioSubmodeSelect = (submode) => {
    setSelectedMode(submode); // 'trio-ffa' o 'trio-ball9'
    const initialPlayers = Array(3).fill('');
    setPlayers(initialPlayers);
    setTrackedPlayers(Array(3).fill(false));
    setCurrentPage('players');
  };

  const handlePlayerNameChange = (index, value) => {
    const newPlayers = [...players];
    newPlayers[index] = value;
    setPlayers(newPlayers);
  };

  const addPlayer = () => {
    if (selectedMode === 'torneo') {
      setPlayers([...players, '']);
      setTrackedPlayers([...trackedPlayers, false]);
    }
  };

  const removePlayer = (index) => {
    if (selectedMode === 'torneo' && players.length > 4) {
      const newPlayers = players.filter((_, i) => i !== index);
      const newTracked = trackedPlayers.filter((_, i) => i !== index);
      setPlayers(newPlayers);
      setTrackedPlayers(newTracked);
    }
  };

  const toggleTracking = (index) => {
    const newTracked = [...trackedPlayers];
    newTracked[index] = !newTracked[index];
    setTrackedPlayers(newTracked);
  };

  const startGame = () => {
    const filledPlayers = players.filter(p => p.trim() !== '');
    if (filledPlayers.length === players.length) {
      const initialGameState = {
        mode: selectedMode,
        players: players.map(name => ({
          name: name,
          shots: 0,
          pocketed: 0,
          currentTurn: false
        })),
        startTime: new Date().toISOString(),
        isFinished: false
      };
      initialGameState.players[0].currentTurn = true;
      setGameState(initialGameState);
      setCurrentPlayerIndex(0);
      
      // Per Trio FFA, inizia mostrando tutte le palle (non serve selezione tipo)
      if (selectedMode === 'trio-ffa') {
        setBallType('all');
      } else if (selectedMode === 'trio-ball9') {
        // Per Palla 9, non serve selezione tipo, mostra subito le palle
        setBallType('ball9');
        setBall9Remaining([1, 2, 3, 4, 5, 6, 7, 8, 9]);
      } else {
        setBallType(null); // Selezione normale per altre modalit√†
      }
      
      setRemainingBalls({
        solid: [1, 2, 3, 4, 5, 6, 7],
        striped: [9, 10, 11, 12, 13, 14, 15]
      });
      setGameTime(0);
      setCurrentPage('game');
    } else {
      alert('Per favore, inserisci tutti i nomi dei giocatori prima di iniziare!');
    }
  };

  const pocketBall = (ballNumber) => {
    if (!gameState || gameState.isFinished) return;

    const newGameState = { ...gameState };
    newGameState.players[currentPlayerIndex].shots += 1;
    newGameState.players[currentPlayerIndex].pocketed += 1;
    setGameState(newGameState);

    // Per Palla 9
    if (selectedMode === 'trio-ball9') {
      // Se imbuca la palla 9, vince immediatamente
      if (ballNumber === 9) {
        endGame(currentPlayerIndex);
        return;
      }
      
      // Rimuovi la palla imbucata
      const newBall9Remaining = ball9Remaining.filter(b => b !== ballNumber);
      setBall9Remaining(newBall9Remaining);
      return;
    }

    // Per altre modalit√† (Duo, Trio FFA, ecc.)
    const newRemainingBalls = { ...remainingBalls };
    if (ballNumber <= 7) {
      newRemainingBalls.solid = newRemainingBalls.solid.filter(b => b !== ballNumber);
    } else {
      newRemainingBalls.striped = newRemainingBalls.striped.filter(b => b !== ballNumber);
    }
    setRemainingBalls(newRemainingBalls);
  };

  const pocket8Ball = () => {
    if (!gameState || gameState.isFinished) return;
    endGame(currentPlayerIndex);
  };

  const foul8Ball = () => {
    if (!gameState || gameState.isFinished) return;
    const winnerIndex = (currentPlayerIndex + 1) % gameState.players.length;
    endGame(winnerIndex);
  };

  const nextPlayer = () => {
    if (!gameState || gameState.isFinished) return;

    const newGameState = { ...gameState };
    newGameState.players[currentPlayerIndex].shots += 1;
    newGameState.players[currentPlayerIndex].currentTurn = false;
    
    const nextIndex = (currentPlayerIndex + 1) % newGameState.players.length;
    newGameState.players[nextIndex].currentTurn = true;
    
    setCurrentPlayerIndex(nextIndex);
    setGameState(newGameState);
    
    // Alterna il tipo di palle solo se √® stato gi√† selezionato un tipo E se NON √® modalit√† quartetto o trio-ffa o trio-ball9
    if (ballType && ballType !== 'all' && ballType !== 'ball9' && selectedMode !== 'quartetto') {
      setBallType(ballType === 'solid' ? 'striped' : 'solid');
    }
  };

  const endGame = (winnerIndex) => {
    if (!gameState || gameState.isFinished) return;

    const newGameState = { ...gameState };
    newGameState.isFinished = true;
    newGameState.winner = newGameState.players[winnerIndex].name;
    newGameState.endTime = new Date().toISOString();
    const gameDuration = Math.floor((new Date(newGameState.endTime) - new Date(newGameState.startTime)) / 1000);
    newGameState.duration = gameDuration;

    const newGlobalStats = { ...globalStats };
    
    newGameState.players.forEach((player, index) => {
      if (trackedPlayers[index]) {
        if (!newGlobalStats[player.name]) {
          newGlobalStats[player.name] = {
            totalShots: 0,
            totalPocketed: 0,
            gamesPlayed: 0,
            gamesWon: 0,
            totalGameTime: 0
          };
        }
        
        newGlobalStats[player.name].totalShots += player.shots;
        newGlobalStats[player.name].totalPocketed += player.pocketed;
        newGlobalStats[player.name].gamesPlayed += 1;
        newGlobalStats[player.name].totalGameTime += gameDuration;
        
        if (index === winnerIndex) {
          newGlobalStats[player.name].gamesWon += 1;
        }
      }
    });

    saveGlobalStats(newGlobalStats);
    setGameState(newGameState);
    setShowMatchStats(false);
    
    const completedGames = JSON.parse(localStorage.getItem('completedGames') || '[]');
    completedGames.push(newGameState);
    localStorage.setItem('completedGames', JSON.stringify(completedGames));
    
    setCurrentPage('results');
  };

  const calculateStats = (player) => {
    const accuracy = player.shots > 0 ? ((player.pocketed / player.shots) * 100).toFixed(1) : 0;
    return { accuracy };
  };

  const calculateGlobalStats = (playerName) => {
    const stats = globalStats[playerName];
    if (!stats) return null;
    
    const accuracy = stats.totalShots > 0 
      ? ((stats.totalPocketed / stats.totalShots) * 100).toFixed(1) 
      : 0;
    const winRate = stats.gamesPlayed > 0 
      ? ((stats.gamesWon / stats.gamesPlayed) * 100).toFixed(1) 
      : 0;
    
    return { ...stats, accuracy, winRate };
  };

  const formatTime = (seconds) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
      return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
      return `${minutes}m ${secs}s`;
    } else {
      return `${secs}s`;
    }
  };

  const resetAllStats = () => {
    localStorage.removeItem('globalPlayerStats');
    localStorage.removeItem('completedGames');
    
    setGlobalStats({});
    setShowResetModal(false);
    setCurrentPage('home');
    setGameState(null);
    setPlayers([]);
    setSelectedMode(null);
    setTrackedPlayers([]);
    setShowMatchStats(false);
    setBallType(null);
    setRemainingBalls({
      solid: [1, 2, 3, 4, 5, 6, 7],
      striped: [9, 10, 11, 12, 13, 14, 15]
    });
    setGameTime(0);
    setCurrentPlayerIndex(0);
  };

  const downloadStatsPDF = () => {
    const sortedPlayers = Object.entries(globalStats)
      .map(([name, stats]) => {
        const accuracy = stats.totalShots > 0 ? ((stats.totalPocketed / stats.totalShots) * 100).toFixed(1) : 0;
        const winRate = stats.gamesPlayed > 0 ? ((stats.gamesWon / stats.gamesPlayed) * 100).toFixed(1) : 0;
        return { name, ...stats, accuracy, winRate };
      })
      .sort((a, b) => b.gamesWon - a.gamesWon);

    let htmlContent = `
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Statistiche Biliardo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; background: #f5f5f5; }
    h1 { color: #2d6a4f; text-align: center; border-bottom: 3px solid #52b788; padding-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #2d6a4f; color: white; font-weight: bold; }
    tr:hover { background: #f8f9fa; }
    .medal { font-size: 24px; }
    .stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stat-value { font-size: 32px; font-weight: bold; color: #2d6a4f; }
    .stat-label { color: #666; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üé± Statistiche Biliardo</h1>
  <div class="stats-summary">
    <div class="stat-card">
      <div class="stat-value">${sortedPlayers.length}</div>
      <div class="stat-label">Giocatori Totali</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${sortedPlayers.reduce((sum, p) => sum + p.gamesPlayed, 0)}</div>
      <div class="stat-label">Partite Giocate</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${sortedPlayers.reduce((sum, p) => sum + p.totalPocketed, 0)}</div>
      <div class="stat-label">Palle Imbucate</div>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th>Pos.</th>
        <th>Giocatore</th>
        <th>Partite</th>
        <th>Vittorie</th>
        <th>Win Rate</th>
        <th>Precisione</th>
        <th>Tempo Gioco</th>
      </tr>
    </thead>
    <tbody>
`;

    sortedPlayers.forEach((player, index) => {
      const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
      htmlContent += `
      <tr>
        <td class="medal">${medal} ${index + 1}</td>
        <td><strong>${player.name}</strong></td>
        <td>${player.gamesPlayed}</td>
        <td>${player.gamesWon}</td>
        <td>${player.winRate}%</td>
        <td>${player.accuracy}%</td>
        <td>${formatTime(player.totalGameTime)}</td>
      </tr>
`;
    });

    htmlContent += `
    </tbody>
  </table>
  <p style="text-align: center; color: #666; margin-top: 40px;">
    Report generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}
  </p>
</body>
</html>
`;

    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Statistiche_Biliardo_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  // HOME PAGE
  if (currentPage === 'home') {
    let bestPlayer = null;
    const playersWithStats = Object.entries(globalStats).map(([name, stats]) => {
      const winRate = stats.gamesPlayed > 0 ? (stats.gamesWon / stats.gamesPlayed) * 100 : 0;
      const accuracy = stats.totalShots > 0 ? (stats.totalPocketed / stats.totalShots) * 100 : 0;
      const score = (winRate * 0.7) + (accuracy * 0.3);
      return { name, ...stats, winRate, accuracy, score };
    });
    
    if (playersWithStats.length > 0) {
      bestPlayer = playersWithStats.sort((a, b) => b.score - a.score)[0];
    }

    const completedGames = JSON.parse(localStorage.getItem('completedGames') || '[]');
    const lastGame = completedGames.length > 0 ? completedGames[completedGames.length - 1] : null;
    
    let lastGamePodium = [];
    if (lastGame) {
      lastGamePodium = [...lastGame.players]
        .sort((a, b) => b.pocketed - a.pocketed)
        .slice(0, 3);
    }

    const topPlayers = Object.entries(globalStats)
      .map(([name, stats]) => ({
        name,
        ...stats,
        winRate: stats.gamesPlayed > 0 ? ((stats.gamesWon / stats.gamesPlayed) * 100).toFixed(1) : 0
      }))
      .sort((a, b) => b.gamesWon - a.gamesWon)
      .slice(0, 3);

    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        {showResetModal && (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl">
              <div className="text-center mb-6">
                <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 className="text-2xl font-bold text-gray-900 mb-4">ATTENZIONE</h3>
                <p className="text-gray-700">
                  Questa azione eliminer√† <strong>TUTTE</strong> le statistiche e partite salvate.
                </p>
                <p className="text-gray-700 mt-2">
                  Sei sicuro di voler continuare?
                </p>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <button
                  onClick={() => setShowResetModal(false)}
                  className="bg-gray-300 hover:bg-gray-400 text-gray-900 font-bold py-3 px-6 rounded-lg transition"
                >
                  Annulla
                </button>
                <button
                  onClick={resetAllStats}
                  className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition"
                >
                  Conferma
                </button>
              </div>
            </div>
          </div>
        )}

        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <div className="flex items-center">
                <span className="text-2xl font-bold text-white">üé± Sfida Biliardo</span>
              </div>
              <div className="hidden md:flex space-x-8">
                <button 
                  onClick={() => setCurrentPage('statistics')}
                  className="text-gray-200 hover:text-white transition font-semibold"
                >
                  Statistiche
                </button>
                <button 
                  onClick={() => setCurrentPage('rules')}
                  className="text-gray-200 hover:text-white transition font-semibold"
                >
                  Regole
                </button>
              </div>
              <button 
                onClick={() => setCurrentPage('modes')}
                className="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-6 py-2 rounded-lg transition transform hover:scale-105"
              >
                Nuova Partita
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
          <div className="text-center">
            <h1 className="text-5xl md:text-6xl font-bold text-white mb-6">
              Sfida i tuoi amici!
            </h1>
            <p className="text-xl md:text-2xl text-gray-200 mb-12 max-w-3xl mx-auto">
              Inserisci i nomi dei giocatori per iniziare una epica battaglia sul panno verde. 
              Preparati a dimostrare chi √® il vero maestro del biliardo!
            </p>
            <button 
              onClick={() => setCurrentPage('modes')}
              className="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg px-10 py-4 rounded-lg transition transform hover:scale-105 shadow-xl"
            >
              Inizia Ora
            </button>
          </div>

          {bestPlayer && (
            <div className="mt-16 max-w-2xl mx-auto">
              <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-8 shadow-2xl transform hover:scale-105 transition">
                <div className="text-center">
                  <div className="text-5xl mb-4">üëë</div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">Miglior Giocatore</h2>
                  <div className="text-4xl font-bold text-white mb-6">{bestPlayer.name}</div>
                  
                  <div className="grid grid-cols-2 gap-6">
                    <div className="bg-white bg-opacity-20 rounded-lg p-4">
                      <div className="text-sm text-gray-900 font-semibold mb-1">Win Rate</div>
                      <div className="text-3xl font-bold text-white">{bestPlayer.winRate.toFixed(1)}%</div>
                      <div className="text-xs text-gray-800 mt-1">
                        {bestPlayer.gamesWon}/{bestPlayer.gamesPlayed} partite
                      </div>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-4">
                      <div className="text-sm text-gray-900 font-semibold mb-1">Precisione</div>
                      <div className="text-3xl font-bold text-white">{bestPlayer.accuracy.toFixed(1)}%</div>
                      <div className="text-xs text-gray-800 mt-1">
                        {bestPlayer.totalPocketed}/{bestPlayer.totalShots} tiri
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {lastGamePodium.length > 0 && (
            <div className="mt-12 max-w-4xl mx-auto">
              <h2 className="text-3xl font-bold text-white text-center mb-8">
                üìä Podio Ultima Partita
              </h2>
              <div className={`grid grid-cols-1 ${lastGamePodium.length === 2 ? 'md:grid-cols-2' : 'md:grid-cols-3'} gap-6`}>
                {lastGamePodium.map((player, index) => {
                  const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                  const bgColor = index === 0 
                    ? 'from-yellow-500 to-yellow-600' 
                    : index === 1 
                      ? 'from-gray-300 to-gray-400' 
                      : 'from-orange-600 to-orange-700';
                  
                  return (
                    <div 
                      key={player.name}
                      className={`bg-gradient-to-br ${bgColor} rounded-xl p-6 shadow-xl ${
                        index === 0 ? 'transform scale-110' : ''
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-5xl mb-3">{medal}</div>
                        <div className="text-2xl font-bold text-gray-900 mb-2">{player.name}</div>
                        <div className="text-4xl font-bold text-white mb-1">#{index + 1}</div>
                        <div className="text-sm text-gray-800 font-semibold">
                          {player.pocketed} palle imbucate
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {topPlayers.length > 0 && (
            <div className="mt-20">
              <h2 className="text-3xl font-bold text-white text-center mb-8">üèÜ Top 3 Giocatori</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {topPlayers.map((player, index) => (
                  <div 
                    key={player.name}
                    className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center transform hover:scale-105 transition"
                  >
                    <div className="text-5xl mb-3">
                      {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                    </div>
                    <div className="text-2xl font-bold text-white mb-2">{player.name}</div>
                    <div className="text-yellow-400 text-xl font-semibold mb-3">
                      {player.gamesWon} vittorie
                    </div>
                    <div className="text-gray-200 text-sm space-y-1">
                      <div>Partite: {player.gamesPlayed}</div>
                      <div>Win Rate: {player.winRate}%</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center hover:bg-opacity-20 transition">
              <div className="text-4xl mb-3">‚è±Ô∏è</div>
              <div className="text-2xl font-bold text-yellow-400 mb-2">
                {completedGames.length > 0
                  ? formatTime(Math.floor(completedGames.reduce((sum, g) => sum + (g.duration || 0), 0) / completedGames.length))
                  : '--'}
              </div>
              <div className="text-gray-200">Durata Media Partita</div>
              <div className="text-xs text-gray-400 mt-2">
                Su {completedGames.length} partite totali
              </div>
            </div>
            
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center hover:bg-opacity-20 transition">
              <div className="text-4xl mb-3">üî•</div>
              <div className="text-2xl font-bold text-yellow-400 mb-2">
                {lastGame && lastGame.winner ? lastGame.winner : '--'}
              </div>
              <div className="text-gray-200">Ultimo Vincitore</div>
              <div className="text-xs text-gray-400 mt-2">
                {lastGame ? modes[lastGame.mode].name : 'Nessuna partita'}
              </div>
            </div>
            
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center hover:bg-opacity-20 transition">
              <div className="text-4xl mb-3">üé≤</div>
              <div className="text-2xl font-bold text-yellow-400 mb-2">
                {completedGames.length > 0
                  ? Object.entries(
                      completedGames.reduce((acc, game) => {
                        acc[game.mode] = (acc[game.mode] || 0) + 1;
                        return acc;
                      }, {})
                    ).sort((a, b) => b[1] - a[1])[0]?.[0] 
                    ? modes[Object.entries(
                        completedGames.reduce((acc, game) => {
                          acc[game.mode] = (acc[game.mode] || 0) + 1;
                          return acc;
                        }, {})
                      ).sort((a, b) => b[1] - a[1])[0][0]].name
                    : '--'
                  : '--'}
              </div>
              <div className="text-gray-200">Modalit√† Pi√π Giocata</div>
              <div className="text-xs text-gray-400 mt-2">
                Preferita dal gruppo
              </div>
            </div>
          </div>

          <div className="max-w-md mx-auto mt-16">
            <button
              onClick={() => setShowResetModal(true)}
              className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition transform hover:scale-105 shadow-xl"
            >
              üóëÔ∏è Azzera Statistiche
            </button>
          </div>
        </div>
      </div>
    );
  }

  // MODES PAGE - Selezione modalit√†
  if (currentPage === 'modes') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <span className="text-2xl font-bold text-white">üé± Scegli Modalit√†</span>
              <button 
                onClick={() => setCurrentPage('home')}
                className="text-gray-200 hover:text-white transition"
              >
                ‚Üê Indietro
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <h2 className="text-4xl font-bold text-white text-center mb-12">Seleziona una modalit√† di gioco</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {/* Duo */}
            <div
              onClick={() => handleModeSelect('duo')}
              className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-8 cursor-pointer transform hover:scale-105 hover:bg-opacity-20 transition"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">üë•</div>
                <h3 className="text-2xl font-bold text-white mb-2">Duo</h3>
                <p className="text-gray-200 mb-4">2 giocatori</p>
                <p className="text-sm text-gray-300">
                  Classico 1 vs 1. Piene contro Rigate, chi imbuca la palla 8 per primo vince!
                </p>
              </div>
            </div>

            {/* Trio */}
            <div
              onClick={() => handleModeSelect('trio')}
              className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-8 cursor-pointer transform hover:scale-105 hover:bg-opacity-20 transition"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">üë®‚Äçüë©‚Äçüë¶</div>
                <h3 className="text-2xl font-bold text-white mb-2">Trio</h3>
                <p className="text-gray-200 mb-4">3 giocatori</p>
                <p className="text-sm text-gray-300">
                  Tre varianti disponibili: classico a turni, tutti contro tutti, o Palla 9!
                </p>
              </div>
            </div>

            {/* Quartetto */}
            <div
              onClick={() => handleModeSelect('quartetto')}
              className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-8 cursor-pointer transform hover:scale-105 hover:bg-opacity-20 transition"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <h3 className="text-2xl font-bold text-white mb-2">Quartetto</h3>
                <p className="text-gray-200 mb-4">4 giocatori</p>
                <p className="text-sm text-gray-300">
                  Tutti contro tutti! Ogni giocatore pu√≤ imbucare qualsiasi palla. Chi imbuca la palla 8 vince!
                </p>
              </div>
            </div>

            {/* Torneo */}
            <div
              onClick={() => handleModeSelect('torneo')}
              className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-8 cursor-pointer transform hover:scale-105 transition shadow-xl col-span-1 md:col-span-2 lg:col-span-3"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">üèÜ</div>
                <h3 className="text-3xl font-bold text-gray-900 mb-2">Torneo</h3>
                <p className="text-gray-800 mb-4 text-lg font-semibold">4+ giocatori</p>
                <p className="text-gray-700 max-w-2xl mx-auto">
                  Sfida epica con numero illimitato di giocatori! Perfetto per eventi e competizioni tra amici.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // TRIO SUBMODES PAGE
  if (currentPage === 'trio-submodes') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <span className="text-2xl font-bold text-white">üé± Trio - Scegli Variante</span>
              <button 
                onClick={() => setCurrentPage('modes')}
                className="text-gray-200 hover:text-white transition"
              >
                ‚Üê Indietro
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <h2 className="text-4xl font-bold text-white text-center mb-12">Scegli la variante Trio</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* Trio Classico (a turni alternati con piene/rigate) */}
            <div
              onClick={() => handleTrioSubmodeSelect('trio')}
              className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-8 cursor-pointer transform hover:scale-105 hover:bg-opacity-20 transition"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">üîÑ</div>
                <h3 className="text-2xl font-bold text-white mb-2">Classico</h3>
                <p className="text-sm text-gray-300 mt-4">
                  A turni alternati. I giocatori si alternano tra palle piene e rigate.
                </p>
              </div>
            </div>

            {/* Trio Free-for-All */}
            <div
              onClick={() => handleTrioSubmodeSelect('trio-ffa')}
              className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-8 cursor-pointer transform hover:scale-105 hover:bg-opacity-20 transition"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">‚öîÔ∏è</div>
                <h3 className="text-2xl font-bold text-white mb-2">Tutti contro Tutti</h3>
                <p className="text-sm text-gray-300 mt-4">
                  Ogni giocatore pu√≤ imbucare qualsiasi palla. Chi imbuca la palla 8 vince!
                </p>
              </div>
            </div>

            {/* Trio Palla 9 */}
            <div
              onClick={() => handleTrioSubmodeSelect('trio-ball9')}
              className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-8 cursor-pointer transform hover:scale-105 transition shadow-xl"
            >
              <div className="text-center">
                <div className="text-6xl mb-4">9Ô∏è‚É£</div>
                <h3 className="text-2xl font-bold text-white mb-2">Palla 9</h3>
                <p className="text-sm text-white mt-4">
                  Imbuca le palle in ordine (1-9). Chi imbuca la palla 9 vince immediatamente!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // PLAYERS PAGE
  if (currentPage === 'players') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <span className="text-2xl font-bold text-white">üé± Inserisci Giocatori</span>
              <button 
                onClick={() => setCurrentPage('modes')}
                className="text-gray-200 hover:text-white transition"
              >
                ‚Üê Indietro
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <h2 className="text-4xl font-bold text-white text-center mb-4">
            {modes[selectedMode].name}
          </h2>
          <p className="text-center text-gray-200 mb-12">
            Inserisci i nomi dei giocatori per iniziare
          </p>

          <div className="space-y-4 mb-8">
            {players.map((player, index) => (
              <div key={index} className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-4">
                <div className="flex items-center gap-4">
                  <div className="flex-shrink-0 w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center">
                    <Users className="text-gray-900" size={24} />
                  </div>
                  <input
                    type="text"
                    value={player}
                    onChange={(e) => handlePlayerNameChange(index, e.target.value)}
                    placeholder={`Giocatore ${index + 1}`}
                    className="flex-1 bg-white bg-opacity-20 text-white placeholder-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  />
                  <button
                    onClick={() => toggleTracking(index)}
                    className={`px-4 py-3 rounded-lg font-semibold transition ${
                      trackedPlayers[index]
                        ? 'bg-green-600 text-white'
                        : 'bg-white bg-opacity-20 text-gray-300 hover:bg-opacity-30'
                    }`}
                  >
                    {trackedPlayers[index] ? '‚úì Traccia' : 'Non tracciare'}
                  </button>
                  {selectedMode === 'torneo' && players.length > 4 && (
                    <button
                      onClick={() => removePlayer(index)}
                      className="px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition"
                    >
                      ‚úï
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>

          {selectedMode === 'torneo' && (
            <button
              onClick={addPlayer}
              className="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-4 rounded-lg transition mb-8 flex items-center justify-center gap-2"
            >
              <Plus size={24} />
              Aggiungi Giocatore
            </button>
          )}

          <button
            onClick={startGame}
            className="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg py-4 rounded-lg transition transform hover:scale-105 shadow-xl flex items-center justify-center gap-2"
          >
            Inizia Partita
            <ArrowRight size={24} />
          </button>

          <div className="mt-8 bg-blue-500 bg-opacity-20 rounded-lg p-4">
            <p className="text-white text-sm">
              üí° <strong>Suggerimento:</strong> Seleziona "Traccia" per i giocatori di cui vuoi salvare le statistiche globali.
            </p>
          </div>
        </div>
      </div>
    );
  }

  // GAME PAGE
  if (currentPage === 'game') {
    if (!gameState) return null;

    const currentPlayer = gameState.players[currentPlayerIndex];

    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg sticky top-0 z-10">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <div className="flex items-center gap-4">
                <span className="text-2xl font-bold text-white">üé± In Gioco</span>
                <span className="text-yellow-400 font-semibold">‚è±Ô∏è {formatTime(gameTime)}</span>
              </div>
              <button 
                onClick={() => {
                  if (window.confirm('Sei sicuro di voler abbandonare la partita?')) {
                    setCurrentPage('home');
                    setGameState(null);
                  }
                }}
                className="text-gray-200 hover:text-white transition"
              >
                Abbandona
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Turno corrente */}
          <div className="text-center mb-8">
            <h2 className="text-4xl font-bold text-yellow-400 mb-2">
              Turno di {currentPlayer.name}
            </h2>
            <div className="flex items-center justify-center gap-4">
              <div className="text-white">
                Tiri: <span className="font-bold text-yellow-400">{currentPlayer.shots}</span>
              </div>
              <div className="text-white">
                Imbucate: <span className="font-bold text-green-400">{currentPlayer.pocketed}</span>
              </div>
              <div className="text-white">
                Precisione: <span className="font-bold text-blue-400">
                  {currentPlayer.shots > 0 ? ((currentPlayer.pocketed / currentPlayer.shots) * 100).toFixed(1) : 0}%
                </span>
              </div>
            </div>
          </div>

          {/* Selezione tipo palle (solo per modalit√† specifiche) */}
          {!ballType && selectedMode !== 'trio-ffa' && selectedMode !== 'trio-ball9' && selectedMode !== 'quartetto' && (
            <div className="max-w-2xl mx-auto mb-8">
              <h3 className="text-2xl font-bold text-white text-center mb-6">
                Scegli il tipo di palle per {currentPlayer.name}
              </h3>
              <div className="grid grid-cols-2 gap-6">
                <button
                  onClick={() => setBallType('solid')}
                  className="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-12 rounded-xl transition transform hover:scale-105 shadow-xl"
                >
                  <div className="text-6xl mb-4">üî¥</div>
                  <div className="text-2xl">Palle Piene</div>
                  <div className="text-sm mt-2 opacity-90">1 - 7</div>
                </button>
                <button
                  onClick={() => setBallType('striped')}
                  className="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-12 rounded-xl transition transform hover:scale-105 shadow-xl"
                >
                  <div className="text-6xl mb-4">üîµ</div>
                  <div className="text-2xl">Palle Rigate</div>
                  <div className="text-sm mt-2 opacity-90">9 - 15</div>
                </button>
              </div>
            </div>
          )}

          {/* Griglia palle - Per Palla 9 */}
          {selectedMode === 'trio-ball9' && ballType === 'ball9' && (
            <div className="max-w-4xl mx-auto mb-8">
              <h3 className="text-2xl font-bold text-white text-center mb-6">
                Palle Rimanenti (Imbuca in ordine crescente!)
              </h3>
              <div className="grid grid-cols-3 sm:grid-cols-5 gap-4">
                {ball9Remaining.map(ball => (
                  <button
                    key={ball}
                    onClick={() => pocketBall(ball)}
                    className={`aspect-square rounded-xl font-bold text-2xl transition transform hover:scale-110 shadow-lg ${
                      ball === 9 
                        ? 'bg-gradient-to-br from-yellow-400 to-yellow-500 text-gray-900 ring-4 ring-yellow-300'
                        : 'bg-gradient-to-br from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700'
                    }`}
                  >
                    {ball}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Griglia palle - Per altre modalit√† */}
          {ballType && ballType !== 'ball9' && (
            <>
              {(ballType === 'solid' || ballType === 'all' || selectedMode === 'trio-ffa' || selectedMode === 'quartetto') && remainingBalls.solid.length > 0 && (
                <div className="max-w-4xl mx-auto mb-8">
                  <h3 className="text-2xl font-bold text-white text-center mb-6">
                    Palle Piene {ballType === 'solid' ? '(Le tue palle)' : ''}
                  </h3>
                  <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 gap-4">
                    {remainingBalls.solid.map(ball => (
                      <button
                        key={ball}
                        onClick={() => pocketBall(ball)}
                        className="aspect-square bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-bold text-2xl transition transform hover:scale-110 shadow-lg"
                      >
                        {ball}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {(ballType === 'striped' || ballType === 'all' || selectedMode === 'trio-ffa' || selectedMode === 'quartetto') && remainingBalls.striped.length > 0 && (
                <div className="max-w-4xl mx-auto mb-8">
                  <h3 className="text-2xl font-bold text-white text-center mb-6">
                    Palle Rigate {ballType === 'striped' ? '(Le tue palle)' : ''}
                  </h3>
                  <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 gap-4">
                    {remainingBalls.striped.map(ball => (
                      <button
                        key={ball}
                        onClick={() => pocketBall(ball)}
                        className="aspect-square bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl font-bold text-2xl transition transform hover:scale-110 shadow-lg"
                      >
                        {ball}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </>
          )}

          {/* Palla 8 */}
          {ballType && ballType !== 'ball9' && (
            <>
              {((ballType === 'solid' && remainingBalls.solid.length === 0) ||
                (ballType === 'striped' && remainingBalls.striped.length === 0) ||
                (ballType === 'all' || selectedMode === 'trio-ffa' || selectedMode === 'quartetto')) && (
                <div className="max-w-2xl mx-auto mb-8">
                  <h3 className="text-2xl font-bold text-white text-center mb-6">
                    Palla 8 {(ballType === 'solid' && remainingBalls.solid.length === 0) || 
                             (ballType === 'striped' && remainingBalls.striped.length === 0) 
                      ? '(Ultima palla!)' : ''}
                  </h3>
                  <div className="grid grid-cols-2 gap-6">
                    <button
                      onClick={pocket8Ball}
                      className="bg-gradient-to-br from-gray-800 to-black hover:from-gray-900 hover:to-gray-800 text-white font-bold py-12 rounded-xl transition transform hover:scale-105 shadow-xl"
                    >
                      <div className="text-6xl mb-4">‚ö´</div>
                      <div className="text-2xl">Imbucata 8</div>
                      <div className="text-sm mt-2 opacity-90">Vittoria!</div>
                    </button>
                    <button
                      onClick={foul8Ball}
                      className="bg-gradient-to-br from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-12 rounded-xl transition transform hover:scale-105 shadow-xl"
                    >
                      <div className="text-6xl mb-4">‚ùå</div>
                      <div className="text-2xl">Fallo sulla 8</div>
                      <div className="text-sm mt-2 opacity-90">Sconfitta</div>
                    </button>
                  </div>
                </div>
              )}
            </>
          )}

          {/* Bottone Prossimo Giocatore */}
          {ballType && (
            <div className="max-w-2xl mx-auto mt-8">
              <button
                onClick={nextPlayer}
                className="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold text-lg py-4 rounded-lg transition transform hover:scale-105 shadow-xl"
              >
                Prossimo Giocatore ‚Üí
              </button>
            </div>
          )}

          {/* Tabella giocatori */}
          <div className="max-w-4xl mx-auto mt-12">
            <h3 className="text-2xl font-bold text-white text-center mb-6">Giocatori</h3>
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl overflow-hidden">
              <table className="w-full">
                <thead className="bg-white bg-opacity-10">
                  <tr>
                    <th className="px-6 py-4 text-left text-white font-bold">Giocatore</th>
                    <th className="px-6 py-4 text-center text-white font-bold">Tiri</th>
                    <th className="px-6 py-4 text-center text-white font-bold">Imbucate</th>
                    <th className="px-6 py-4 text-center text-white font-bold">Precisione</th>
                  </tr>
                </thead>
                <tbody>
                  {gameState.players.map((player, index) => {
                    const stats = calculateStats(player);
                    return (
                      <tr 
                        key={index}
                        className={`border-t border-white border-opacity-10 ${
                          player.currentTurn ? 'bg-yellow-500 bg-opacity-20' : ''
                        }`}
                      >
                        <td className="px-6 py-4 text-white font-semibold">
                          {player.currentTurn && '‚ñ∂ '}{player.name}
                        </td>
                        <td className="px-6 py-4 text-center text-white">{player.shots}</td>
                        <td className="px-6 py-4 text-center text-green-400 font-bold">{player.pocketed}</td>
                        <td className="px-6 py-4 text-center text-blue-400 font-bold">{stats.accuracy}%</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // RESULTS PAGE
  if (currentPage === 'results') {
    if (!gameState) return null;

    const sortedPlayers = [...gameState.players].sort((a, b) => b.pocketed - a.pocketed);

    if (showMatchStats) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
          <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16">
                <span className="text-2xl font-bold text-white">üìä Statistiche Dettagliate</span>
                <button 
                  onClick={() => setShowMatchStats(false)}
                  className="text-gray-200 hover:text-white transition"
                >
                  ‚Üê Indietro
                </button>
              </div>
            </div>
          </nav>

          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <h2 className="text-4xl font-bold text-white text-center mb-12">
              Analisi Completa della Partita
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
              {gameState.players.map((player, index) => {
                const stats = calculateStats(player);
                const isWinner = player.name === gameState.winner;

                return (
                  <div
                    key={index}
                    className={`bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 ${
                      isWinner ? 'ring-4 ring-yellow-400' : ''
                    }`}
                  >
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-2xl font-bold text-white">{player.name}</h3>
                      {isWinner && <div className="text-3xl">üëë</div>}
                    </div>

                    <div className="space-y-4">
                      <div className="bg-white bg-opacity-10 rounded-lg p-4">
                        <div className="text-sm text-gray-300 mb-1">Precisione</div>
                        <div className="text-4xl font-bold text-yellow-400">{stats.accuracy}%</div>
                        <div className="text-xs text-gray-400 mt-2">
                          (Palle imbucate / Tiri eseguiti)
                        </div>
                      </div>

                      {player.shots > 0 && (
                        <div className="mt-4 pt-4 border-t border-white border-opacity-20">
                          <div className="text-sm text-gray-300 space-y-1">
                            <div className="flex justify-between">
                              <span>Tiri riusciti:</span>
                              <span className="text-green-400 font-semibold">{player.pocketed}</span>
                            </div>
                            <div className="flex justify-between">
                              <span>Tiri mancati:</span>
                              <span className="text-red-400 font-semibold">{player.shots - player.pocketed}</span>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 mb-8">
              <h3 className="text-2xl font-bold text-white mb-4 text-center">
                Riepilogo Partita
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="text-center">
                  <div className="text-3xl font-bold text-yellow-400">
                    {gameState.players.reduce((sum, p) => sum + p.shots, 0)}
                  </div>
                  <div className="text-gray-300">Tiri Totali</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-yellow-400">
                    {gameState.players.reduce((sum, p) => sum + p.pocketed, 0)}
                  </div>
                  <div className="text-gray-300">Palle Imbucate Totali</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-yellow-400">
                    {gameState.players.reduce((sum, p) => sum + p.shots, 0) > 0
                      ? ((gameState.players.reduce((sum, p) => sum + p.pocketed, 0) / 
                         gameState.players.reduce((sum, p) => sum + p.shots, 0)) * 100).toFixed(1)
                      : 0}%
                  </div>
                  <div className="text-gray-300">Precisione Media Partita</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-bold text-yellow-400">
                    {formatTime(gameState.duration || 0)}
                  </div>
                  <div className="text-gray-300">Durata Partita</div>
                </div>
              </div>
            </div>

            <div className="max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                onClick={() => setShowMatchStats(false)}
                className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-4 rounded-lg transition"
              >
                ‚Üê Torna ai Risultati
              </button>
              <button
                onClick={() => {
                  setCurrentPage('home');
                  setGameState(null);
                  setShowMatchStats(false);
                }}
                className="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 rounded-lg transition transform hover:scale-105"
              >
                Torna alla Home
              </button>
            </div>
          </div>
        </div>
      );
    }

    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <span className="text-2xl font-bold text-white">üé± Risultati Partita</span>
              <button 
                onClick={() => setCurrentPage('home')}
                className="text-gray-200 hover:text-white transition"
              >
                Home ‚Üí
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <div className="text-center mb-12">
            <div className="text-6xl mb-4">üèÜ</div>
            <h2 className="text-5xl font-bold text-yellow-400 mb-2">{gameState.winner}</h2>
            <p className="text-2xl text-white">Ha vinto la partita!</p>
          </div>

          <div className="max-w-4xl mx-auto mb-12">
            <h3 className="text-3xl font-bold text-white text-center mb-8">Classifica Finale</h3>
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 mb-6">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                  <div className="text-2xl font-bold text-yellow-400">üèÜ Vincitore</div>
                  <div className="text-xl text-white mt-2">{gameState.winner}</div>
                </div>
                <div>
                  <div className="text-lg font-bold text-gray-300">Tiri Totali</div>
                  <div className="text-2xl text-white mt-2">{gameState.players.reduce((sum, p) => sum + p.shots, 0)}</div>
                </div>
                <div>
                  <div className="text-lg font-bold text-gray-300">Palle Imbucate</div>
                  <div className="text-2xl text-white mt-2">{gameState.players.reduce((sum, p) => sum + p.pocketed, 0)}</div>
                </div>
                <div>
                  <div className="text-lg font-bold text-gray-300">Durata</div>
                  <div className="text-2xl text-white mt-2">‚è±Ô∏è {formatTime(gameState.duration || 0)}</div>
                </div>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {sortedPlayers.slice(0, 3).map((player, index) => {
                const stats = calculateStats(player);
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                return (
                  <div 
                    key={player.name}
                    className={`bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center ${
                      index === 0 ? 'transform scale-110 bg-opacity-20' : ''
                    }`}
                  >
                    <div className="text-5xl mb-3">{medal}</div>
                    <div className="text-2xl font-bold text-white mb-4">{player.name}</div>
                    <div className="space-y-2 text-gray-200">
                      <div className="flex justify-between">
                        <span>Palle imbucate:</span>
                        <span className="font-bold text-yellow-400">{player.pocketed}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Tiri totali:</span>
                        <span className="font-bold text-white">{player.shots}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Precisione:</span>
                        <span className="font-bold text-yellow-400">{stats.accuracy}%</span>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="max-w-2xl mx-auto space-y-4">
            <button
              onClick={() => setShowMatchStats(true)}
              className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg transition transform hover:scale-105 flex items-center justify-center gap-2"
            >
              <BarChart3 size={24} />
              Statistiche Partita
            </button>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                onClick={() => {
                  setCurrentPage('home');
                  setGameState(null);
                  setShowMatchStats(false);
                }}
                className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-4 rounded-lg transition"
              >
                Torna alla Home
              </button>
              <button
                onClick={() => {
                  setCurrentPage('modes');
                  setGameState(null);
                  setShowMatchStats(false);
                }}
                className="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 rounded-lg transition transform hover:scale-105"
              >
                Nuova Partita
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // STATISTICS PAGE
  if (currentPage === 'statistics') {
    const sortedPlayers = Object.entries(globalStats)
      .map(([name, stats]) => {
        const accuracy = stats.totalShots > 0 ? ((stats.totalPocketed / stats.totalShots) * 100).toFixed(1) : 0;
        const winRate = stats.gamesPlayed > 0 ? ((stats.gamesWon / stats.gamesPlayed) * 100).toFixed(1) : 0;
        return { name, ...stats, accuracy, winRate };
      })
      .sort((a, b) => b.gamesWon - a.gamesWon);

    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <span className="text-2xl font-bold text-white">üìä Statistiche Globali</span>
              <button 
                onClick={() => setCurrentPage('home')}
                className="text-gray-200 hover:text-white transition"
              >
                Home ‚Üí
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          {sortedPlayers.length === 0 ? (
            <div className="text-center py-20">
              <div className="text-6xl mb-6">üìä</div>
              <h2 className="text-3xl font-bold text-white mb-4">Nessuna statistica disponibile</h2>
              <p className="text-gray-200 mb-8">Gioca alcune partite per vedere le statistiche qui!</p>
              <button
                onClick={() => setCurrentPage('modes')}
                className="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold px-8 py-3 rounded-lg transition transform hover:scale-105"
              >
                Inizia una Partita
              </button>
            </div>
          ) : (
            <>
              <div className="text-center mb-12">
                <h2 className="text-4xl font-bold text-white mb-4">Classifica Generale</h2>
                <p className="text-gray-200">Statistiche di tutti i giocatori tracciati</p>
              </div>

              <div className="mb-8">
                <button
                  onClick={downloadStatsPDF}
                  className="bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-3 rounded-lg transition transform hover:scale-105 shadow-xl"
                >
                  üì• Scarica Report HTML
                </button>
              </div>

              <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl overflow-hidden">
                <table className="w-full">
                  <thead className="bg-white bg-opacity-10">
                    <tr>
                      <th className="px-6 py-4 text-left text-white font-bold">Pos.</th>
                      <th className="px-6 py-4 text-left text-white font-bold">Giocatore</th>
                      <th className="px-6 py-4 text-center text-white font-bold">Partite</th>
                      <th className="px-6 py-4 text-center text-white font-bold">Vittorie</th>
                      <th className="px-6 py-4 text-center text-white font-bold">Win Rate</th>
                      <th className="px-6 py-4 text-center text-white font-bold">Precisione</th>
                      <th className="px-6 py-4 text-center text-white font-bold">Tempo Totale</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedPlayers.map((player, index) => {
                      const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                      return (
                        <tr 
                          key={player.name}
                          className="border-t border-white border-opacity-10 hover:bg-white hover:bg-opacity-5 transition"
                        >
                          <td className="px-6 py-4 text-white font-semibold">
                            <span className="text-2xl mr-2">{medal}</span>
                            {index + 1}
                          </td>
                          <td className="px-6 py-4 text-white font-bold">{player.name}</td>
                          <td className="px-6 py-4 text-center text-white">{player.gamesPlayed}</td>
                          <td className="px-6 py-4 text-center text-yellow-400 font-bold">{player.gamesWon}</td>
                          <td className="px-6 py-4 text-center text-green-400 font-bold">{player.winRate}%</td>
                          <td className="px-6 py-4 text-center text-blue-400 font-bold">{player.accuracy}%</td>
                          <td className="px-6 py-4 text-center text-gray-300">{formatTime(player.totalGameTime)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center">
                  <div className="text-4xl mb-3">üë•</div>
                  <div className="text-3xl font-bold text-yellow-400 mb-2">{sortedPlayers.length}</div>
                  <div className="text-gray-200">Giocatori Tracciati</div>
                </div>
                <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center">
                  <div className="text-4xl mb-3">üéÆ</div>
                  <div className="text-3xl font-bold text-yellow-400 mb-2">
                    {sortedPlayers.reduce((sum, p) => sum + p.gamesPlayed, 0)}
                  </div>
                  <div className="text-gray-200">Partite Totali</div>
                </div>
                <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center">
                  <div className="text-4xl mb-3">üéØ</div>
                  <div className="text-3xl font-bold text-yellow-400 mb-2">
                    {sortedPlayers.reduce((sum, p) => sum + p.totalPocketed, 0)}
                  </div>
                  <div className="text-gray-200">Palle Imbucate</div>
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    );
  }

  // RULES PAGE
  if (currentPage === 'rules') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-emerald-900">
        <nav className="bg-green-950 bg-opacity-50 backdrop-blur-sm shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <span className="text-2xl font-bold text-white">üìñ Regole del Gioco</span>
              <button 
                onClick={() => setCurrentPage('home')}
                className="text-gray-200 hover:text-white transition"
              >
                Home ‚Üí
              </button>
            </div>
          </div>
        </nav>

        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <h2 className="text-4xl font-bold text-white text-center mb-12">Come si Gioca</h2>

          <div className="space-y-6">
            {/* Duo */}
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6">
              <h3 className="text-2xl font-bold text-yellow-400 mb-4">üë• Duo (2 giocatori)</h3>
              <p className="text-gray-200 mb-3">
                Modalit√† classica 1 contro 1. Un giocatore ha le palle piene (1-7), l'altro le palle rigate (9-15).
              </p>
              <ul className="list-disc list-inside text-gray-200 space-y-2">
                <li>Ogni giocatore deve imbucare tutte le proprie palle</li>
                <li>Dopo aver imbucato tutte le tue palle, devi imbucare la palla 8 nera per vincere</li>
                <li>Se imbuchi la palla 8 prima di aver finito le tue palle, perdi</li>
                <li>I giocatori si alternano nei turni</li>
              </ul>
            </div>

            {/* Trio */}
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6">
              <h3 className="text-2xl font-bold text-yellow-400 mb-4">üë®‚Äçüë©‚Äçüë¶ Trio (3 giocatori)</h3>
              <p className="text-gray-200 mb-3">Tre varianti disponibili:</p>
              
              <div className="space-y-4 mt-4">
                <div className="bg-white bg-opacity-5 rounded-lg p-4">
                  <h4 className="text-xl font-bold text-white mb-2">üîÑ Classico</h4>
                  <p className="text-gray-200">
                    I giocatori si alternano tra palle piene e rigate. Ogni turno cambia il tipo di palle da imbucare.
                  </p>
                </div>

                <div className="bg-white bg-opacity-5 rounded-lg p-4">
                  <h4 className="text-xl font-bold text-white mb-2">‚öîÔ∏è Tutti contro Tutti</h4>
                  <p className="text-gray-200">
                    Ogni giocatore pu√≤ imbucare qualsiasi palla. Chi imbuca la palla 8 vince la partita!
                  </p>
                </div>

                <div className="bg-white bg-opacity-5 rounded-lg p-4">
                  <h4 className="text-xl font-bold text-white mb-2">9Ô∏è‚É£ Palla 9</h4>
                  <p className="text-gray-200 mb-2">
                    Le palle devono essere imbucate in ordine crescente (1, 2, 3... fino a 9).
                  </p>
                  <ul className="list-disc list-inside text-gray-200 space-y-1">
                    <li>Chi imbuca la palla 9 vince immediatamente!</li>
                    <li>Non √® necessario imbucare tutte le palle prima della 9</li>
                    <li>Bisogna rispettare l'ordine numerico</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* Quartetto */}
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6">
              <h3 className="text-2xl font-bold text-yellow-400 mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Quartetto (4 giocatori)</h3>
              <p className="text-gray-200 mb-3">
                Modalit√† free-for-all dove tutti giocano contro tutti.
              </p>
              <ul className="list-disc list-inside text-gray-200 space-y-2">
                <li>Ogni giocatore pu√≤ imbucare qualsiasi palla (piene o rigate)</li>
                <li>Non ci sono squadre o assegnazioni di palle</li>
                <li>Chi imbuca la palla 8 nera vince la partita</li>
                <li>I giocatori si alternano in sequenza</li>
              </ul>
            </div>

            {/* Torneo */}
            <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-6">
              <h3 className="text-2xl font-bold text-gray-900 mb-4">üèÜ Torneo (4+ giocatori)</h3>
              <p className="text-gray-800 mb-3">
                Modalit√† speciale per grandi gruppi e competizioni.
              </p>
              <ul className="list-disc list-inside text-gray-800 space-y-2">
                <li>Numero illimitato di giocatori (minimo 4)</li>
                <li>Stesso funzionamento del Quartetto</li>
                <li>Perfetto per feste ed eventi</li>
                <li>Traccia le statistiche di tutti i partecipanti</li>
              </ul>
            </div>

            {/* Statistiche */}
            <div className="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6">
              <h3 className="text-2xl font-bold text-yellow-400 mb-4">üìä Statistiche</h3>
              <p className="text-gray-200 mb-3">
                L'app tiene traccia delle performance di ogni giocatore:
              </p>
              <ul className="list-disc list-inside text-gray-200 space-y-2">
                <li><strong>Precisione:</strong> percentuale di palle imbucate rispetto ai tiri effettuati</li>
                <li><strong>Win Rate:</strong> percentuale di vittorie sul totale delle partite giocate</li>
                <li><strong>Tiri Totali:</strong> numero complessivo di tiri effettuati</li>
                <li><strong>Tempo di Gioco:</strong> tempo totale trascorso in partita</li>
              </ul>
              <p className="text-gray-300 mt-4 text-sm">
                üí° Ricorda di attivare il tracciamento per i giocatori di cui vuoi salvare le statistiche!
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

export default BiliardoApp;